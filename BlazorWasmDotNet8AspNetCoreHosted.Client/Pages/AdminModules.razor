@* Сторінка адміністрування модулів *@
@page "/admin/modules"
@using System.Net.Http.Json
@using System.Globalization
@using System.Linq
@using System.Collections.Generic
@using System.Text.RegularExpressions
@using System.Text.Json
@using BlazorWasmDotNet8AspNetCoreHosted.Shared.DTOs
@using Microsoft.AspNetCore.Components.Forms
@inject BlazorWasmDotNet8AspNetCoreHosted.Client.Services.IAdminApi Admin
@inject IJSRuntime JS
@inject HttpClient Http



<PageTitle>Модулі</PageTitle>

<h3 class="mb-3">Модулі</h3>

@if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger">@error</div>
}
@if (!string.IsNullOrWhiteSpace(ok))
{
    <div class="alert alert-success">@ok</div>
}

<div class="card p-3 mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Імпорт модулів з .docx</h5>
        @if (importBusy)
        {
            <span class="text-muted small">Завантаження...</span>
        }
    </div>
    <div class="row g-3 align-items-end">
        <div class="col-12 col-md-6">
            <label class="form-label d-block">Файл .docx</label>
            <InputFile class="d-none" id="docxFileInput" OnChange="OnImportFileChange" accept=".docx" />
            <label for="docxFileInput" class="btn btn-outline-secondary me-2 mb-2">Оберіть файл</label>
            <span class="text-muted small">@ImportFileCaption</span>
        </div>
        <div class="col-12 col-md-6 d-flex flex-wrap gap-2">
            <button class="btn btn-outline-primary"
                    @onclick="() => ImportDocx(false)"
                    disabled="@(importBusy || importFile is null)">
                Попередній перегляд
            </button>
            <button class="btn btn-primary"
                    @onclick="() => ImportDocx(true)"
                    disabled="@(importBusy || importFile is null)">
                Імпортувати
            </button>
        </div>
    </div>
    @if (!string.IsNullOrWhiteSpace(importError))
    {
        <div class="alert alert-danger mt-3">@importError</div>
    }
    @if (!string.IsNullOrWhiteSpace(importOk))
    {
        <div class="alert alert-success mt-3">@importOk</div>
    }
    @if (importResult is not null)
    {
        <div class="mt-3">
            <div class="d-flex flex-wrap gap-3 align-items-center">
                <span class="fw-semibold">Курс: @importResult.CourseName</span>
                <span class="badge @(importResult.CourseFound ? "bg-success" : "bg-danger")">
                    @(importResult.CourseFound ? "Знайдено у БД" : "Не знайдено у БД")
                </span>
                <span class="text-muted small">Модулів: @importResult.Modules.Count | Занять: @ImportedTopicsCount</span>
            </div>
            @if (importResult.Warnings.Any())
            {
                <div class="alert alert-warning mt-2">
                    <div class="fw-semibold mb-1">Попередження:</div>
                    <ul class="mb-0">
                        @foreach (var w in importResult.Warnings.Take(10))
                        {
                            <li>@w</li>
                        }
                        @if (importResult.Warnings.Count > 10)
                        {
                            <li>... ще @((importResult.Warnings.Count - 10)) попереджень</li>
                        }
                    </ul>
                </div>
            }
            <div class="table-responsive mt-3">
                <table class="table table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Код</th>
                            <th>Назва</th>
                            <th>Кредити</th>
                            <th>Занять</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var m in importResult.Modules)
                        {
                            <tr>
                                <td>@m.Code</td>
                                <td>@m.Title</td>
                                <td>@m.Credits</td>
                                <td>@(m.Topics?.Count ?? 0)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

<div class="card p-3 mb-3">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div>
            <h5 class="mb-0">Очистити всі модулі</h5>
            <div class="text-muted small">Видаляє всі модулі, плани та теми.</div>
        </div>
        <button class="btn btn-outline-danger" @onclick="ClearAllModules" disabled="@clearBusy">Очистити все</button>
    </div>
    @if (!string.IsNullOrWhiteSpace(clearError))
    {
        <div class="alert alert-danger mt-2">@clearError</div>
    }
    @if (!string.IsNullOrWhiteSpace(clearOk))
    {
        <div class="alert alert-success mt-2">@clearOk</div>
    }
</div>

<div class="card p-3 mb-3">
    <div class="row g-2">
        <div class="col-12 col-md-3">
            <label class="form-label">Код</label>
            <input class="form-control" @bind="form.Code" />
        </div>
        <div class="col-12 col-md-5">
            <label class="form-label">Назва</label>
            <input class="form-control" @bind="form.Title" />
        </div>
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <label class="form-label mb-0">Курси модуля</label>
                <button type="button"
                        class="btn btn-sm btn-outline-secondary"
                        @onclick="SelectAllCourses"
                        disabled="@(!courses.Any())">Обрати всі</button>
            </div>
            <div class="form-text small mb-2">
                Оберіть усі курси, до яких належить модуль.
            </div>
            <div class="course-chip-grid">
                @foreach (var c in courses)
                {
                    var cid = c.Id;
                    var isSelected = IsCourseSelected(cid);

                    <button type="button"
                            class="course-chip btn btn-sm @(isSelected ? "btn-primary" : "btn-outline-primary")"
                            @onclick="() => ToggleCourse(cid)">
                        @c.Name
                    </button>
                }
            </div>
            @if (SelectedCourseNames.Any())
            {
                <div class="mt-2 small text-muted">
                    Обрані курси: @string.Join(", ", SelectedCourseNames)
                </div>
            }
        </div>

        
        <div class="col-12 col-lg-6">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <label class="form-label mb-0">Дозволені корпуси</label>
                <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="SelectAllBuildings">Обрати всі</button>
            </div>
            <div class="border rounded p-2" style="max-height:200px;overflow:auto;">
                @foreach (var b in buildings)
                {
                    var bid = b.Id ?? 0;
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox"
                               checked="@form.AllowedBuildingIds.Contains(bid)"
                               @onchange="e => ToggleBuilding(bid, (bool)e.Value!)" id="bld_@bid" />
                        <label class="form-check-label" for="bld_@bid">@b.Name</label>
                    </div>
                }
            </div>
        </div>

        
        <div class="col-12 col-lg-6">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <label class="form-label mb-0">Дозволені аудиторії</label>
                <button type="button" class="btn btn-sm btn-outline-secondary"
                        @onclick="SelectAllRooms"
                        disabled="@(!rooms.Any())">Обрати всі</button>
            </div>
            @if (!rooms.Any())
            {
                <div class="border rounded p-2 bg-light text-muted small">Оберіть корпус, щоб побачити перелік аудиторій.</div>
            }
            else
            {
                <div class="border rounded p-2" style="max-height:200px;overflow:auto;">
                    @foreach (var r in rooms)
                    {
                        var rid = r.Id ?? 0;
                        if (rid <= 0)
                        {
                            continue;
                        }
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox"
                                   checked="@form.AllowedRoomIds.Contains(rid)"
                                   @onchange="e => Toggle(form.AllowedRoomIds, rid, (bool)e.Value!)" id="room_@rid" />
                            <label class="form-check-label" for="room_@rid">@r.Name</label>
                        </div>
                    }
                </div>
            }
        </div>

        
        <div class="col-12 d-grid mt-2">
            <button class="btn btn-primary" @onclick="Save">Зберегти</button>
        </div>
    </div>
</div>


<div class="card p-3 mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2 gap-2">
        <div class="text-muted small">Відібрано: @SortedAndFiltered.Count() з @items.Count</div>
        <div class="input-group" style="max-width:320px;">
            <span class="input-group-text">Пошук</span>
            <input class="form-control" @bind="filter" @bind:event="oninput" placeholder="Id / код / назва / курс / кредити" />
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-sm align-middle">
            <thead>
                <tr>
                    <th style="width:80px;" class="sortable-th" role="button"
                        @onclick="() => ToggleSort(nameof(ModuleEditDto.Id))">
                        Id @HeaderIcon(nameof(ModuleEditDto.Id))
                    </th>
                    <th class="sortable-th" role="button"
                        @onclick="() => ToggleSort(nameof(ModuleEditDto.Code))">
                        Код @HeaderIcon(nameof(ModuleEditDto.Code))
                    </th>
                    <th class="sortable-th" role="button"
                        @onclick="() => ToggleSort(nameof(ModuleEditDto.Title))">
                        Назва @HeaderIcon(nameof(ModuleEditDto.Title))
                    </th>
                    <th class="sortable-th" role="button"
                        @onclick="() => ToggleSort(CourseField)">
                        Курси @HeaderIcon(CourseField)
                    </th>
                    <th class="sortable-th" role="button"
                        @onclick="() => ToggleSort(nameof(ModuleEditDto.Credits))">
                        Обсяг кредитів @HeaderIcon(nameof(ModuleEditDto.Credits))
                    </th>
                    <th style="width:230px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var m in SortedAndFiltered)
                {
                    <tr>
                        <td>@m.Id</td>
                        <td>@m.Code</td>
                        <td>@m.Title</td>
                        <td>@ModuleCourseSummary(m)</td>
                        <td>@m.Credits</td>
                        <td class="text-end">
                            
                            <button class="btn btn-sm btn-outline-secondary me-2" title="План модуля"
                                    @onclick="() => OpenPlans(m)">
                                План модуля
                            </button>
                            <button class="btn btn-sm btn-outline-primary me-2" @onclick="() => Edit(m)">
                                Редагувати
                            </button>
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => Delete(m.Id!.Value)">
                                Видалити
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>


@if (plansModuleId is not null)
{
    <div class="card p-3">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
            <div>
                <h5 class="mb-0">
                    План модуля: <span class="fw-semibold">@plansModuleTitle</span>
                </h5>
                <div class="d-flex align-items-center gap-2 mt-2">
                    <label class="form-label mb-0 small">Курс</label>
                    <select class="form-select form-select-sm"
                            value="@selectedPlanCourseId"
                            @onchange="OnPlanCourseChanged"
                            disabled="@(!planCourseIds.Any())">
                        @foreach (var cid in planCourseIds)
                        {
                            <option value="@cid">@NameOfCourse(cid)</option>
                        }
                    </select>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" @onclick="ClosePlans">Закрити</button>
                <button class="btn btn-sm btn-primary" @onclick="SavePlans" disabled="@(selectedPlanCourseId <= 0)">Зберегти план</button>
            </div>
        </div>

        
        <div class="row g-3 mt-3">
            <div class="col-12 col-md-4">
                <label class="form-label">Обсяг кредитів (за планом)</label>
                <input type="number" min="0" step="0.1" class="form-control" @bind="planCourse.Credits" />
                <div class="form-text">≈ @Math.Round(planCourse.Credits * 30M) год.</div>
            </div>
            <div class="col-12 col-md-4">
                <label class="form-label">Розкладено</label>
                <input type="number" class="form-control" value="@planCourse.ScheduledHours" disabled />
            </div>
            <div class="col-12 col-md-4 d-flex align-items-end">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="planActive" @bind="planCourse.IsActive" />
                    <label class="form-check-label" for="planActive">Активний</label>
                </div>
            </div>
        </div>

        <div class="small text-muted mt-2">
            * Зміни набувають чинності після натискання кнопки <b>Зберегти план</b> та повторного перезавантаження модуля.
        </div>

        <hr />
        
        <div class="card module-topics-card p-3 mb-3">
            <div class="module-topics-header">

                <h6 class="mb-0">Керування заняттями</h6>

                <p class="small text-muted mb-0">Вкажіть код у форматі <code>1.1.1.1</code> та заповніть інші поля.</p>

            </div>
            <div class="row g-3 align-items-end">
                <div class="col-12 col-lg-4">
                    <label class="form-label text-nowrap">Код заняття</label>
                    <input class="form-control" @bind="topicCodeInput" />
                </div>
                <div class="col-12 col-lg-3">
                    <label class="form-label text-nowrap">Тип заняття</label>
                    <select class="form-select" @bind="topicForm.LessonTypeId">
                        <option value="0">- Оберіть тип заняття -</option>
                        @foreach (var lt in lessonTypes)
                        {
                            <option value="@lt.Id">@lt.Name</option>
                        }
                    </select>
                </div>
                <div class="col-12 col-sm-4 col-lg-2">
                    <label class="form-label text-nowrap">Годин аудиторних</label>
                    <input type="number" min="0" class="form-control" @bind="topicForm.AuditoriumHours" @bind:after="SyncTotalHours" />
                </div>
                <div class="col-12 col-sm-4 col-lg-2">
                    <label class="form-label text-nowrap">Годин самостійних</label>
                    <input type="number" min="0" class="form-control" @bind="topicForm.SelfStudyHours" @bind:after="SyncTotalHours" />
                </div>
                <div class="col-12 col-sm-4 col-lg-1">
                    <label class="form-label text-nowrap">Всього</label>
                    <input type="number" min="0" class="form-control" value="@topicForm.TotalHours" readonly />
                </div>
            </div>
            <div class="module-topics-actions d-flex flex-wrap gap-2 mt-3">
                <button type="button" class="btn btn-sm btn-primary" @onclick="SaveTopic" disabled="@(!plansModuleId.HasValue)">Зберегти заняття</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="ClearTopicForm" disabled="@(!plansModuleId.HasValue)">Очистити поля</button>
            </div>
            <div class="table-responsive mt-3">
                <table class="table table-sm align-middle module-topics-table">
                    <thead>
                        <tr>
                            <th class="text-nowrap">Код</th>
                            <th class="text-nowrap">Тип</th>
                            <th class="text-nowrap">Годин всього</th>
                            <th class="text-nowrap">Годин аудиторних</th>
                            <th class="text-nowrap">Годин самостійних</th>
                            <th class="module-topics-col-groups">Заплановані групи</th>
                            <th class="module-topics-col-groups">Відпрацьовані групи</th>
                            <th class="module-topics-col-actions"></th>

                        </tr>

                    </thead>
                    <tbody>
                        @if (moduleTopics.Count == 0)
                        {
                            <tr>
                                <td colspan="8" class="text-muted text-center">Немає записів.</td>
                            </tr>
                        }
                        else
                        {
                            foreach (var topic in moduleTopics)
                            {
                                <tr>
                                    <td>@topic.TopicCode</td>
                                    <td>@topic.LessonTypeName</td>
                                    <td>@topic.TotalHours</td>
                                    <td>@topic.AuditoriumHours</td>
                                    <td>@topic.SelfStudyHours</td>
                                    <td class="module-topics-col-groups">
                                        <span>@GroupsHoursCaption(topic.PlannedGroupsHours ?? new())</span>
                                    </td>

                                    <td class="module-topics-col-groups">
                                        <span>@GroupsHoursCaption(topic.CompletedGroupsHours ?? new())</span>
                                    </td>

                                    <td class="module-topics-col-actions text-end">
                                        <div class="btn-group btn-group-sm me-1 mb-1 mb-sm-0">
                                            <button class="btn btn-outline-secondary" @onclick="() => EditTopic(topic)">Редагувати</button>
                                            <button class="btn btn-outline-danger" @onclick="() => DeleteTopic(topic.Id)">Видалити</button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }

                    </tbody>
                    @if (moduleTopics.Any())
                    {
                        var totals = CalculateModuleTopicTotals();
                        <tfoot class="table-light">
                            <tr class="fw-semibold">
                                <td colspan="2" class="text-end pe-3">Всього за модуль</td>
                                <td>@totals.total</td>
                                <td>@totals.auditorium</td>
                                <td>@totals.self</td>
                                <td colspan="2"></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    }
                </table>
            </div>
        </div>
    </div>
}

@code {
    
    private string? error, ok;
    private IBrowserFile? importFile;
    private DocxImportResultDto? importResult;
    private bool importBusy;
    private string? importError;
    private string? importOk;
    private bool clearBusy;
    private string? clearError;
    private string? clearOk;

    
    private List<ModuleEditDto> items = new();
    private ModuleEditDto form = new()
    {
        Id = null,
        Code = string.Empty,
        Title = string.Empty,
        CourseId = 0,
        AllowedRoomIds = new(),
        AllowedBuildingIds = new(),
        CloneCourseIds = new(),
        Credits = 0
    };

    private List<LookupDto> courses = new();
    private IEnumerable<string> SelectedCourseNames
        => CurrentCourseIds()
            .Select(NameOfCourse)
            .Where(name => !string.IsNullOrWhiteSpace(name));
    private List<RoomEditDto> rooms = new();
    private List<RoomEditDto> allRooms = new();
    private List<BuildingEditDto> buildings = new();
    private List<IdCodeNameDto> lessonTypes = new();

    
private int? plansModuleId;
private List<int> planCourseIds = new();
private int selectedPlanCourseId;
private string plansModuleTitle = "";
private string plansModuleCode = "";
private PlanCourseVM planCourse = new();

    
    private List<ModuleTopicViewDto> moduleTopics = new();
    
    private ModuleTopicFormVM topicForm = new();
    private string topicCodeInput = string.Empty;
    // Дозволяємо літери/цифри/крапки/дефіси, щоб підтримати коди на кшталт КП.1.1
    private static readonly Regex TopicCodePattern = new(@"^[A-Za-zА-Яа-яІіЇїЄєҐґ0-9._-]+$");

    
    private const string CourseField = "CourseName";
    private string sortField = nameof(ModuleEditDto.Title);
    private bool sortAsc = true;
    private string? filter;
    /// <summary>
    /// Завантажує дані модулів і довідників під час першого відкриття сторінки.
    /// </summary>

    protected override async Task OnInitializedAsync() => await Load();

    private int ImportedTopicsCount => importResult?.Modules?.Sum(m => m.Topics?.Count ?? 0) ?? 0;
    private string ImportFileCaption => importFile is null
        ? "Файл не обрано"
        : $"{importFile.Name} ({Math.Round(importFile.Size / 1024.0, 1)} КБ)";

    private async Task OnImportFileChange(InputFileChangeEventArgs e)
    {
        importFile = e.FileCount > 0 ? e.File : null;
        importResult = null;
        importError = null;
        importOk = null;
        await InvokeAsync(StateHasChanged);
    }

    private async Task ImportDocx(bool apply)
    {
        if (importFile is null)
        {
            importError = "Оберіть .docx файл для імпорту.";
            importOk = null;
            return;
        }

        try
        {
            importBusy = true;
            importError = null;
            importOk = null;

            importResult = await Admin.ImportModulesFromDocx(importFile, apply);
            importOk = apply ? "Імпорт виконано." : "Прев’ю імпорту отримано.";

            if (apply)
            {
                await Load();
            }
        }
        catch (Exception ex)
        {
            importError = TryParseImportError(ex.Message);
        }
        finally
        {
            importBusy = false;
        }
    }

    private string TryParseImportError(string message)
    {
        try
        {
            using var doc = JsonDocument.Parse(message);
            var root = doc.RootElement;
            var msg = root.TryGetProperty("message", out var m) ? m.GetString() : message;
            var warns = root.TryGetProperty("warnings", out var w) && w.ValueKind == JsonValueKind.Array
                ? string.Join("; ", w.EnumerateArray().Select(x => x.GetString()).Where(s => !string.IsNullOrWhiteSpace(s))!)
                : null;
            return string.IsNullOrWhiteSpace(warns) ? msg ?? message : $"{msg}: {warns}";
        }
        catch
        {
            return message;
        }
    }

    private async Task ClearAllModules()
    {
        clearError = null;
        clearOk = null;
        var confirm = await JS.InvokeAsync<bool>("confirm", "Видалити всі модулі, плани та теми?");
        if (!confirm) return;

        try
        {
            clearBusy = true;
            await Admin.ClearModulesAndPlans();
            clearOk = "Усі модулі та плани очищено.";
            await Load();
        }
        catch (Exception ex)
        {
            clearError = ex.Message;
        }
        finally
        {
            clearBusy = false;
        }
    }

    
    /// <summary>
    /// Отримує список модулів, супровідні довідники та налаштовує стан форми.
    /// </summary>

    
    private async Task Load()
    {
        try
        {
            ok = "Дані модулів завантажено.";

            items = await Admin.GetModules();

            var meta = await Admin.GetMeta();
            courses = meta.Courses ?? new();
            lessonTypes = meta.LessonTypes ?? new();

            allRooms = await Admin.GetRooms() ?? new();
            buildings = await Admin.GetBuildings();

            EnsureBuildingsCoverSelectedRooms();
            UpdateVisibleRooms();
        }
        catch (Exception ex) { error = ex.Message; }
    }

    
    /// <summary>
    /// Додає або вилучає ідентифікатор зі списку залежно від прапорця.
    /// </summary>

    
    private static void Toggle(List<int> list, int id, bool on)
    {
        if (on) { if (!list.Contains(id)) list.Add(id); }
        else list.Remove(id);
    }
    /// <summary>
    /// Перемикає доступність будівлі й оновлює видимі аудиторії.
    /// </summary>
    private void ToggleBuilding(int buildingId, bool on)
    {
        if (buildingId <= 0) return;
        Toggle(form.AllowedBuildingIds, buildingId, on);
        UpdateVisibleRooms();
    }
    /// <summary>
    /// Гарантує, що вибрані аудиторії належать дозволеним будівлям.
    /// </summary>
    private void EnsureBuildingsCoverSelectedRooms()
    {
        if (form.AllowedRoomIds.Count == 0 || allRooms.Count == 0) return;

        var roomBuildingIds = allRooms
            .Where(r => r.Id.HasValue && form.AllowedRoomIds.Contains(r.Id.Value))
            .Select(r => r.BuildingId)
            .Where(id => id > 0)
            .Distinct();

        foreach (var bid in roomBuildingIds)
        {
            if (!form.AllowedBuildingIds.Contains(bid))
            {
                form.AllowedBuildingIds.Add(bid);
            }
        }
    }
    /// <summary>
    /// Формує список аудиторій згідно з вибраними будівлями.
    /// </summary>
    private void UpdateVisibleRooms()
    {
        
        if (form.AllowedBuildingIds.Count == 0)
        {
            rooms = new();
            form.AllowedRoomIds = new();
            return;
        }

        var selectedBuildings = form.AllowedBuildingIds.ToHashSet();
        rooms = allRooms
            .Where(r => r.Id.HasValue && selectedBuildings.Contains(r.BuildingId))
            .OrderBy(r => r.Name, StringComparer.OrdinalIgnoreCase)
            .ToList();

        var validRoomIds = rooms
            .Select(r => r.Id!.Value)
            .ToHashSet();

        form.AllowedRoomIds = form.AllowedRoomIds
            .Where(validRoomIds.Contains)
            .Distinct()
            .ToList();
    }
    /// <summary>
    /// Повертає назву курсу або службове позначення за відсутності значення.
    /// </summary>
    private string NameOfCourse(int id) => courses.FirstOrDefault(c => c.Id == id)?.Name ?? $"#{id}";
    /// <summary>
    /// Повертає всі курси, вибрані в поточній формі.
    /// </summary>
    private List<int> CurrentCourseIds()
    {
        var result = new List<int>();

        if (form.CourseId > 0)
        {
            result.Add(form.CourseId);
        }

        if (form.CloneCourseIds is { Count: > 0 })
        {
            foreach (var id in form.CloneCourseIds)
            {
                if (id > 0 && !result.Contains(id))
                {
                    result.Add(id);
                }
            }
        }

        return result;
    }
    /// <summary>
    /// Збирає ідентифікатори курсів, прив'язаних до переданого модуля.
    /// </summary>
    private static List<int> ModuleCourseIds(ModuleEditDto module)
    {
        var result = new List<int>();

        if (module.CourseId > 0)
        {
            result.Add(module.CourseId);
        }

        if (module.CloneCourseIds is { Count: > 0 })
        {
            foreach (var id in module.CloneCourseIds)
            {
                if (id > 0 && !result.Contains(id))
                {
                    result.Add(id);
                }
            }
        }

        return result;
    }
    /// <summary>
    /// Оновлює DTO модуля списком вибраних курсів.
    /// </summary>
    private static void ApplySelectedCourses(ModuleEditDto target, IEnumerable<int> courseIds)
    {
        var normalized = courseIds?
            .Where(id => id > 0)
            .Distinct()
            .ToList() ?? new List<int>();

        target.CourseId = normalized.FirstOrDefault();
        target.CloneCourseIds = normalized.Skip(1).ToList();
    }
    /// <summary>
    /// Застосовує вибрані курси до поточної форми модуля.
    /// </summary>
    private void ApplySelectedCourses(IEnumerable<int> courseIds)
        => ApplySelectedCourses(form, courseIds);
    /// <summary>
    /// Перевіряє, чи входить курс до переліку вибраних.
    /// </summary>
    private bool IsCourseSelected(int courseId)
        => courseId > 0 && (form.CourseId == courseId || form.CloneCourseIds.Contains(courseId));
    /// <summary>
    /// Формує текстовий список курсів, пов'язаних із модулем.
    /// </summary>
    private string ModuleCourseSummary(ModuleEditDto module)
    {
        var summary = ModuleCourseIds(module)
            .Select(NameOfCourse)
            .Where(name => !string.IsNullOrWhiteSpace(name));

        return string.Join(", ", summary);
    }

    private static string GroupsHoursCaption(IEnumerable<TopicGroupHoursDto> rows)
    {
        var parts = new List<string>();
        foreach (var row in rows)
        {
            var chunks = new List<string>();
            if (row.AuditoriumHours > 0) chunks.Add($"{row.AuditoriumHours} год. ауд.");
            if (row.SelfStudyHours > 0) chunks.Add($"{row.SelfStudyHours} год. сам.");
            var suffix = chunks.Count > 0 ? $" ({string.Join(", ", chunks)})" : string.Empty;
            parts.Add($"{row.GroupName}{suffix}");
        }

        return parts.Count == 0 ? "—" : string.Join("; ", parts);
    }
    /// <summary>
    /// Заповнює форму даними модуля для редагування.
    /// </summary>
    private void Edit(ModuleEditDto m)
    {
        form = new(m.Id, m.Code, m.Title, m.CourseId, new List<int>(m.AllowedRoomIds), new List<int>(m.AllowedBuildingIds), m.Credits);
        form.CloneCourseIds = new List<int>(m.CloneCourseIds ?? new());
        ApplySelectedCourses(ModuleCourseIds(m));
        EnsureBuildingsCoverSelectedRooms();
        UpdateVisibleRooms();
    }

    /// <summary>
    /// Перевіряє введені дані та зберігає модуль через API.
    /// </summary>

    private async Task Save()
    {
        try
        {
            var selectedCourses = CurrentCourseIds();
            if (selectedCourses.Count == 0)
            {
                error = "Оберіть принаймні один курс для модуля.";
                return;
            }

            ApplySelectedCourses(selectedCourses);
            await Admin.UpsertModule(form);
            await Load();
            ok = "Модуль успішно збережено.";
            form = new()
            {
                Id = null,
                Code = string.Empty,
                Title = string.Empty,
                CourseId = 0,
                AllowedRoomIds = new(),
                AllowedBuildingIds = new(),
                CloneCourseIds = new(),
                Credits = 0
            };
            UpdateVisibleRooms();
        }
        catch (Exception ex) { error = ex.Message; }
    }

    
    /// <summary>
    /// Видаляє модуль і перезавантажує перелік.
    /// </summary>

    
    private async Task Delete(int id)

    {

        try

        {
            var module = items.FirstOrDefault(m => m.Id == id);

            var caption = module is null ? $"#{id}" : $"{module.Code} — {module.Title}";

            var confirmed = await JS.InvokeAsync<bool>("confirm", $"Видалити модуль {caption}? Дію не можна скасувати.");

            if (!confirmed) return;



            await Admin.DeleteModule(id);

            await Load();

            ok = "Модуль успішно видалено.";

        }

        catch (Exception ex) { error = ex.Message; }

    }



    ///
    /// <summary>
    /// Відкриває панель планів для обраного модуля та завантажує дані.
    /// </summary>

    private async Task OpenPlans(ModuleEditDto m)
    {
        try
        {
            ok = "Дані плану модуля завантажено.";

            plansModuleId = m.Id;
            plansModuleTitle = $"{m.Code} - {m.Title}";
            plansModuleCode = m.Code ?? string.Empty;
            planCourseIds = ModuleCourseIds(m);
            selectedPlanCourseId = planCourseIds.FirstOrDefault();

            var moduleCredits = m.Credits;

            if (plansModuleId is int moduleId && selectedPlanCourseId > 0)
            {
                await LoadPlanDetails(moduleId, selectedPlanCourseId, moduleCredits);
            }
            else
            {
                var normalizedHours = (int)Math.Round(Math.Max(0m, moduleCredits) * 30m);
                planCourse = new PlanCourseVM
                {
                    CourseId = 0,
                    TargetHours = normalizedHours,
                    Credits = moduleCredits,
                    ScheduledHours = 0,
                    IsActive = true
                };
            }

            if (plansModuleId is int id)
            {
                await LoadTopics(id);
            }
        }
        catch (Exception ex) { error = ex.Message; }
    }
    /// <summary>
    /// Скидає стан панелі планів і приховує її.
    /// </summary>
    private void ClosePlans()
    {
        plansModuleId = null;
        planCourseIds = new();
        selectedPlanCourseId = 0;
        plansModuleTitle = "";
        plansModuleCode = "";
        planCourse = new();
        moduleTopics.Clear();
        ResetTopicForm(0);
    }
    /// <summary>
    /// Зберігає налаштування плану годин для вибраного курсу.
    /// </summary>
    private async Task SavePlans()
    {
        if (plansModuleId is null || selectedPlanCourseId <= 0) return;

        try
        {
            var normalizedHours = (int)Math.Round(Math.Max(0m, planCourse.Credits) * 30m);
            await Admin.UpsertCourseModulePlan(
                plansModuleId.Value,
                selectedPlanCourseId,
                new SaveCourseModulePlanDto(normalizedHours, planCourse.IsActive)
            );
            planCourse.TargetHours = normalizedHours;

            ok = "План модуля оновлено.";

            await LoadPlanDetails(plansModuleId.Value, selectedPlanCourseId, planCourse.Credits);

            var moduleRow = items.FirstOrDefault(x => x.Id == plansModuleId);
            if (moduleRow is not null)
            {
                moduleRow.Credits = planCourse.Credits;
            }
        }
        catch (Exception ex) { error = ex.Message; }
    }
    /// <summary>
    /// Завантажує деталі плану годин для модуля та курсу.
    /// </summary>
    private async Task LoadPlanDetails(int moduleId, int courseId, decimal fallbackCredits)
    {
        if (courseId <= 0)
        {
            var normalizedHours = (int)Math.Round(Math.Max(0m, fallbackCredits) * 30m);
            planCourse = new PlanCourseVM
            {
                CourseId = 0,
                TargetHours = normalizedHours,
                Credits = fallbackCredits,
                ScheduledHours = 0,
                IsActive = true
            };
            return;
        }

        var dto = await Admin.GetCourseModulePlan(moduleId, courseId);
        if (dto is null)
        {
            var normalizedHours = (int)Math.Round(Math.Max(0m, fallbackCredits) * 30m);
            planCourse = new PlanCourseVM
            {
                CourseId = courseId,
                TargetHours = normalizedHours,
                Credits = fallbackCredits,
                ScheduledHours = 0,
                IsActive = true
            };
        }
        else
        {
            planCourse = new PlanCourseVM
            {
                CourseId = courseId,
                TargetHours = dto.TargetHours,
                Credits = Math.Round(dto.TargetHours / 30m, 2),
                ScheduledHours = dto.ScheduledHours,
                IsActive = dto.IsActive
            };
        }
    }
    /// <summary>
    /// Реагує на зміну курсу у плані та підвантажує його дані.
    /// </summary>
    private async Task OnPlanCourseChanged(ChangeEventArgs e)
    {
        if (plansModuleId is null) return;
        if (e?.Value is null) return;
        if (!int.TryParse(e.Value.ToString(), out var nextCourseId)) return;
        if (!planCourseIds.Contains(nextCourseId)) return;
        if (nextCourseId <= 0 || nextCourseId == selectedPlanCourseId) return;

        selectedPlanCourseId = nextCourseId;
        var module = items.FirstOrDefault(x => x.Id == plansModuleId);
        var credits = module?.Credits ?? planCourse.Credits;
        await LoadPlanDetails(plansModuleId.Value, selectedPlanCourseId, credits);
    }


    
    /// <summary>
    /// Ініціалізує форму теми з типовими значеннями для вказаного модуля.
    /// </summary>

    private void ResetTopicForm(int moduleId)

    {

        var nextOrder = moduleTopics.Count + 1;

        var defaultLessonType = lessonTypes.FirstOrDefault()?.Id ?? 0;



        topicForm = new ModuleTopicFormVM

        {

            Id = null,

            ModuleId = moduleId,

            Order = nextOrder,

            TopicCode = string.Empty,

            LessonTypeId = defaultLessonType > 0 ? defaultLessonType : null,

            TotalHours = 0,

            AuditoriumHours = 0,

            SelfStudyHours = 0,
        };



        topicCodeInput = string.Empty;

    }
    /// <summary>
    /// Підтримує сумарну кількість годин у відповідності до складових.
    /// </summary>

    private void SyncTotalHours()
    {
        var safeAuditorium = Math.Max(0, topicForm.AuditoriumHours ?? 0);
        var safeSelf = Math.Max(0, topicForm.SelfStudyHours ?? 0);

        topicForm.AuditoriumHours = safeAuditorium;
        topicForm.SelfStudyHours = safeSelf;
        topicForm.TotalHours = safeAuditorium + safeSelf;
    }
    /// <summary>
    /// Очищає форму теми та встановлює значення за замовчуванням.
    /// </summary>
    private void ClearTopicForm()
    {
        ResetTopicForm(plansModuleId ?? 0);
    }
    /// <summary>
    /// Завантажує теми модуля та готує агреговану інформацію.
    /// </summary>

    private async Task LoadTopics(int moduleId)
    {
        try
        {
            moduleTopics = await Admin.GetModuleTopics(moduleId);
            moduleTopics.Sort((a, b) => CompareTopicCodes(a.TopicCode, b.TopicCode));
        }
        catch (Exception ex)
        {
            error = ex.Message;
            moduleTopics = new List<ModuleTopicViewDto>();
        }
        finally
        {
            ResetTopicForm(moduleId);
        }
    }
    /// <summary>
    /// Підраховує загальну кількість годин для тем у модулі.
    /// </summary>
    private (int total, int auditorium, int self) CalculateModuleTopicTotals()
    {
        var total = moduleTopics.Sum(t => Math.Max(0, t.TotalHours));
        var auditorium = moduleTopics.Sum(t => Math.Max(0, t.AuditoriumHours));
        var self = moduleTopics.Sum(t => Math.Max(0, t.SelfStudyHours));
        return (total, auditorium, self);
    }
    /// <summary>
    /// Заповнює форму теми даними для редагування.
    /// </summary>
    private void EditTopic(ModuleTopicViewDto topic)

    {

        topicForm = new ModuleTopicFormVM

        {

            Id = topic.Id,

            ModuleId = topic.ModuleId,

            Order = topic.Order,

            TopicCode = topic.TopicCode ?? string.Empty,

            LessonTypeId = topic.LessonTypeId,

            TotalHours = topic.TotalHours,

            AuditoriumHours = topic.AuditoriumHours,

            SelfStudyHours = topic.SelfStudyHours,
        };

        topicCodeInput = topicForm.TopicCode;

    }
    /// <summary>
    /// Валідує та зберігає тему модуля, оновлює список.
    /// </summary>

    private async Task SaveTopic()

    {

        if (plansModuleId is null) return;

        try

        {

            var moduleId = plansModuleId.Value;

            var rawCode = (topicCodeInput ?? string.Empty).Trim();

            if (string.IsNullOrWhiteSpace(rawCode))

            {

                error = "Вкажіть код заняття.";

                return;

            }



            if (!TopicCodePattern.IsMatch(rawCode))

            {

                error = "Код заняття обовʼязковий.";

                return;

            }



            var lessonTypeId = topicForm.LessonTypeId.HasValue && topicForm.LessonTypeId.Value > 0

                ? topicForm.LessonTypeId.Value

                : lessonTypes.FirstOrDefault()?.Id ?? 0;

            if (lessonTypeId == 0)

            {

                error = "Оберіть тип заняття.";


                return;

            }



            var auditoriumHours = Math.Max(0, topicForm.AuditoriumHours ?? 0);

            var selfStudyHours = Math.Max(0, topicForm.SelfStudyHours ?? 0);

            var totalHours = Math.Max(0, auditoriumHours + selfStudyHours);



            topicForm.ModuleId = moduleId;

            topicForm.TopicCode = rawCode;

            topicForm.LessonTypeId = lessonTypeId;

            topicForm.AuditoriumHours = auditoriumHours;

            topicForm.SelfStudyHours = selfStudyHours;

            topicForm.TotalHours = totalHours;



            var payload = new ModuleTopicDto(

                topicForm.Id,

                moduleId,

                0,

                rawCode,

                lessonTypeId,

                totalHours,

                auditoriumHours,

                selfStudyHours);



            await Admin.UpsertModuleTopic(moduleId, payload);

            ok = "Заняття збережено.";

            await LoadTopics(moduleId);

        }

        catch (Exception ex)

        {

            error = ex.Message;

        }

    }
    /// <summary>
    /// Видаляє тему модуля та перезавантажує дані.
    /// </summary>

    private async Task DeleteTopic(int topicId)

    {

        if (plansModuleId is null) return;

        try

        {

            var topic = moduleTopics.FirstOrDefault(t => t.Id == topicId);

            var caption = topic is null ? $"#{topicId}" : $"{topic.TopicCode} ({topic.LessonTypeName})";

            var confirmed = await JS.InvokeAsync<bool>("confirm", $"Видалити тему {caption}? Дію не можна скасувати.");

            if (!confirmed) return;



            await Admin.DeleteModuleTopic(plansModuleId.Value, topicId);

            ok = "Тему видалено.";

            await LoadTopics(plansModuleId.Value);

        }

        catch (Exception ex)

        {

            error = ex.Message;

        }

    }



    ///
    /// <summary>
    /// Фільтрує перелік модулів за введеним рядком.
    /// </summary>
    private IEnumerable<ModuleEditDto> ApplyFilter(IEnumerable<ModuleEditDto> seq)
    {
        if (string.IsNullOrWhiteSpace(filter)) return seq;
        var f = filter.Trim();

        return seq.Where(m =>
            (m.Id?.ToString().Contains(f, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (m.Code?.Contains(f, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (m.Title?.Contains(f, StringComparison.OrdinalIgnoreCase) ?? false) ||
            ModuleCourseSummary(m).Contains(f, StringComparison.OrdinalIgnoreCase) ||
            m.Credits.ToString(CultureInfo.InvariantCulture).Contains(f, StringComparison.OrdinalIgnoreCase)
        );
    }
    /// <summary>
    /// Сортує перелік модулів згідно з вибраним полем.
    /// </summary>
    private IEnumerable<ModuleEditDto> ApplySort(IEnumerable<ModuleEditDto> seq)
    {
        return (sortField, sortAsc) switch
        {
            (nameof(ModuleEditDto.Id), true) => seq.OrderBy(x => x.Id ?? 0),
            (nameof(ModuleEditDto.Id), false) => seq.OrderByDescending(x => x.Id ?? 0),

            (nameof(ModuleEditDto.Code), true) => seq.OrderBy(x => x.Code),
            (nameof(ModuleEditDto.Code), false) => seq.OrderByDescending(x => x.Code),

            (nameof(ModuleEditDto.Title), true) => seq.OrderBy(x => x.Title),
            (nameof(ModuleEditDto.Title), false) => seq.OrderByDescending(x => x.Title),

            (nameof(ModuleEditDto.Credits), true) => seq.OrderBy(x => x.Credits),
            (nameof(ModuleEditDto.Credits), false) => seq.OrderByDescending(x => x.Credits),

            (CourseField, true) => seq.OrderBy(ModuleCourseSummary),
            (CourseField, false) => seq.OrderByDescending(ModuleCourseSummary),

            _ => seq
        };
    }
    /// <summary>
    /// Повертає модулі після застосування фільтру та сортування.
    /// </summary>
    private IEnumerable<ModuleEditDto> SortedAndFiltered
        => ApplySort(ApplyFilter(items));
    /// <summary>
    /// Змінює параметри сортування для таблиці модулів.
    /// </summary>
    private void ToggleSort(string field)
    {
        if (sortField == field) sortAsc = !sortAsc;
        else
        {
            sortField = field;
            sortAsc = true;
        }
    }
    /// <summary>
    /// Обрізає довгий текст до вказаної довжини для відображення.
    /// </summary>
    private string TruncateText(string? value, int max = 80)
    {
        if (string.IsNullOrWhiteSpace(value)) return string.Empty;
        var trimmed = value.Trim();
        if (trimmed.Length <= max) return trimmed;
        var truncated = trimmed.Substring(0, Math.Min(trimmed.Length, max)).TrimEnd();
        return $"{truncated}…";
    }
    /// <summary>
    /// Повертає піктограму напряму сортування для заголовка.
    /// </summary>
    private MarkupString HeaderIcon(string field)
    {
        if (sortField != field) return new MarkupString(string.Empty);
        var icon = sortAsc ? "&#9650;" : "&#9660;";
        return new MarkupString($"<span class=\"ms-1\">{icon}</span>");
    }
    /// <summary>
    /// Позначає всі доступні аудиторії для модуля.
    /// </summary>
    private void SelectAllRooms()
    {
        
        var allIds = rooms
            .Select(r => r.Id ?? 0)
            .Where(id => id > 0)
            .Distinct()
            .OrderBy(id => id)
            .ToList();
        form.AllowedRoomIds = allIds;
    }
    /// <summary>
    /// Позначає всі курси у списку, щоб швидко застосувати їх до модуля.
    /// </summary>
    private void SelectAllCourses()
    {
        var allIds = courses
            .Select(c => c.Id)
            .Where(id => id > 0)
            .Distinct()
            .ToList();

        var currentPrimary = form.CourseId;
        if (currentPrimary > 0 && allIds.Remove(currentPrimary))
        {
            allIds.Insert(0, currentPrimary);
        }

        ApplySelectedCourses(allIds);
    }
    /// <summary>
    /// Дозволяє всі будівлі для модуля одним кліком.
    /// </summary>
    private void SelectAllBuildings()
    {
        
        var allIds = buildings
            .Select(b => b.Id ?? 0)
            .Where(id => id > 0)
            .Distinct()
            .OrderBy(id => id)
            .ToList();
        form.AllowedBuildingIds = allIds;
        UpdateVisibleRooms();
    }
    /// <summary>
    /// Перемикає належність курсу до вибраного переліку.
    /// </summary>
    private void ToggleCourse(int courseId)
    {
        if (courseId <= 0) return;

        var selected = CurrentCourseIds();

        if (selected.Contains(courseId))
        {
            selected.Remove(courseId);
        }
        else
        {
            selected.Add(courseId);
        }

        ApplySelectedCourses(selected);
    }


    /// <summary>
    /// Порівнює коди тем з урахуванням числових сегментів.
    /// </summary>


    private static int CompareTopicCodes(string? left, string? right)
    {
        var (lp, ln) = ParseTopicCode(left);
        var (rp, rn) = ParseTopicCode(right);

        var prefixDiff = string.Compare(lp, rp, System.StringComparison.OrdinalIgnoreCase);
        if (prefixDiff != 0) return prefixDiff;

        var maxLen = Math.Max(ln.Count, rn.Count);
        for (var i = 0; i < maxLen; i++)
        {
            var l = i < ln.Count ? ln[i] : 0;
            var r = i < rn.Count ? rn[i] : 0;
            var diff = l.CompareTo(r);
            if (diff != 0) return diff;
        }

        return string.Compare(left ?? string.Empty, right ?? string.Empty, System.StringComparison.Ordinal);
    }

    private static (string prefix, IReadOnlyList<int> numbers) ParseTopicCode(string? code)
    {
        if (string.IsNullOrWhiteSpace(code)) return (string.Empty, System.Array.Empty<int>());

        var parts = code.Split('.', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 0) return (string.Empty, System.Array.Empty<int>());

        var first = parts[0];
        var match = Regex.Match(first, @"^([A-Za-zА-Яа-яІіЇїЄєҐґ]+)?(\d+)?$");

        var prefix = match.Success ? match.Groups[1].Value : string.Empty;
        var numbers = new List<int>(parts.Length);

        if (match.Success && match.Groups[2].Success && int.TryParse(match.Groups[2].Value, out var headNum))
        {
            numbers.Add(headNum);
        }
        else if (int.TryParse(first, out var numericFirst))
        {
            numbers.Add(numericFirst);
        }
        else
        {
            // якщо не вдалося розібрати — ставимо MaxValue, щоб такі коди йшли наприкінці
            numbers.Add(int.MaxValue);
        }

        foreach (var p in parts.Skip(1))
        {
            numbers.Add(int.TryParse(p, out var val) ? val : int.MaxValue);
        }

        return (prefix, numbers);
    }


    private sealed class PlanCourseVM
    {
        public decimal Credits { get; set; }
        public int CourseId { get; set; }
        public int TargetHours { get; set; }
        public int ScheduledHours { get; set; }
        public bool IsActive { get; set; }
    }


    
    private sealed class ModuleTopicFormVM

    {

        public int? Id { get; set; }

        public int ModuleId { get; set; }

        public int Order { get; set; }

        public string TopicCode { get; set; } = string.Empty;

        public int? LessonTypeId { get; set; }

        public int TotalHours { get; set; }

        public int? AuditoriumHours { get; set; }

        public int? SelfStudyHours { get; set; }

    }


}

<style>
    
    .course-chip-grid {
        display: flex;
        flex-wrap: wrap;
        gap: .5rem;
    }

    .course-chip {
        min-width: 120px;
    }

    .sortable-th {
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
    }

    
    .module-topics-card {
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        border-radius: 12px;
    }

    .module-topics-header {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 12px;
    }

    .module-topics-actions .btn {
        min-width: 140px;
    }

    .module-topics-table th,
    .module-topics-table td {
        vertical-align: middle;
    }

    .module-topics-col-groups .topic-text-truncate {
        max-width: 220px;
    }

    .topic-text-truncate {
        display: inline-block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        vertical-align: bottom;
    }

    .module-topics-col-actions {
        width: 200px;
        white-space: nowrap;
    }






</style>
